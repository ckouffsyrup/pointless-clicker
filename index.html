<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pointless Clicker — Bits & Prestige</title>
  <style>
    html,body { touch-action: manipulation; }
    body {
      background: #0f0f10;
      color: #eee;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      margin:0;
      padding:20px;
    }
    .container {
      width:100%;
      max-width:420px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
    }

    #cps { color: #c399ff; font-weight:700; margin-bottom:4px; } /* purple CPS */
    #count { font-size:3rem; margin:6px 0; font-weight:700; color:#fff; text-align:center; }

    .controls {
      display:flex;
      flex-direction:column;
      gap:10px;
      width:100%;
      align-items:center;
    }

    button {
      background: #2e8b57;
      color: #fff;
      border: none;
      border-radius:10px;
      padding:12px 28px;
      font-size:1.05rem;
      cursor:pointer;
      width:80%;
      max-width:320px;
      transition: transform .08s, box-shadow .12s;
      -webkit-tap-highlight-color: transparent;
    }
    button:active { transform: scale(.98); }
    .blue { background:#1976d2; }
    .muted { background:#555; }
    .gold { background: #f0b429; color:#111; font-weight:700; }
    .red { background:#e53935; }
    .small { padding:8px 16px; font-size:0.95rem; width:auto; }
    .muted.small { background:#444; color:#ddd; }

    .currents {
      display:flex;
      gap:12px;
      width:100%;
      justify-content:center;
      align-items:center;
      color:#cfcfcf;
      font-size:0.95rem;
      margin-top:6px;
    }
    .currents div { background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:8px; }

    .toast-container {
      position: fixed;
      top: 18px;
      right: 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:2000;
    }
    .toast {
      background: rgba(22,22,22,0.96);
      color:#fff;
      border-left: 5px solid #4caf50;
      padding:10px 14px;
      border-radius:8px;
      min-width:220px;
      transform: translateX(150%);
      opacity:0;
      transition: all .36s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      text-align:left;
    }
    .toast.show { transform: translateX(0); opacity:1; }
    .toast-title { font-weight:700; color:#4caf50; margin-bottom:4px; }
    .toast.gold { border-left-color: gold; }
    .toast.gold .toast-title { color:gold; }

    .panel {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(.98);
      width:92%;
      max-width:420px;
      max-height:80vh;
      overflow:auto;
      background:#161616;
      border-radius:12px;
      border:2px solid rgba(255,255,255,0.03);
      padding:12px;
      display:none;
      z-index:1500;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    }
    
    .panel.show { display:block; animation: pop .18s ease both; }
    @keyframes pop { from { opacity:0; transform:translate(-50%,-50%) scale(.96)} to { opacity:1; transform:translate(-50%,-50%) scale(1)} }

    .panel h2 { margin:8px 0; color:#4caf50; text-align:center; }
    .panel .close { float:right; background:#e53935; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; }

    .achievement { background:#1b1b1b; padding:10px 12px; border-radius:8px; border-left:5px solid #444; margin:8px 0; color:#ddd;}
    .achievement.unlocked { border-left-color:#4caf50; color:#fff; background:#222; }
    .achievement.secret.unlocked { border-left-color:gold; background:#2f2307; color:#fff; box-shadow: inset 0 0 18px rgba(255,200,0,0.03); }
    .achievement .title { font-weight:700; margin-bottom:6px; }
    .no-items { color:#999; text-align:center; font-style:italic; padding:12px 6px; }

    .upgrades { display:flex; flex-direction:column; gap:10px; }
    .upgrade { display:flex; justify-content:space-between; align-items:center; gap:8px; background:#191919; padding:10px; border-radius:8px; }
    .upgrade .meta { text-align:left; }
    .upgrade .meta .name { font-weight:700; color:#ffd; }
    .upgrade button { padding:8px 12px; }

    .stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px; }
    .stat { background:#171717; padding:10px; border-radius:8px; text-align:center; color:#ddd; }

    footer { margin-top:8px; color:#777; font-size:12px; text-align:center; }

    /* responsive adjustments */
    @media (max-width:420px) {
      button { width:88%; }
      .controls { gap:8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="cps">CPS: 0</div>
    <div id="count">0</div>

    <div class="controls">
      <button id="clicker" style="font-size:1.35rem;padding:14px 24px;">Click Me</button>
      <button id="achBtn" class="blue">Achievements</button>
      <button id="upgBtn" class="gold">Upgrades</button>
      <button id="statsBtn" class="muted">Stats</button>
      <button id="prestigeBtn" class="gold" style="display:none;">Prestige</button>
      <button id="resetBtn" class="red">Reset</button>

      <div class="currents" style="margin-top:6px;">
        <div id="bitsCur">Bits: 0</div>
        <div id="bitsPerClick">Bits/Click: 1</div>
        <div id="multCur">x1.00</div>
      </div>
    </div>

    <footer>Pointless Clicker — Bits, upgrades & prestige</footer>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Achievements panel -->
  <div id="achPanel" class="panel" aria-hidden="true">
    <button id="closeAch" class="close">Close</button>
    <h2>Achievements</h2>
    <div id="achList"></div>
  </div>

  <!-- Upgrades panel -->
  <div id="upgPanel" class="panel" aria-hidden="true">
    <button id="closeUpg" class="close">Close</button>
    <h2>Upgrades (Bits shop)</h2>
    <div class="upgrades" id="upgList"></div>
  </div>

  <!-- Stats panel -->
  <div id="statsPanel" class="panel" aria-hidden="true">
    <button id="closeStats" class="close">Close</button>
    <h2>Stats</h2>
    <div class="stats-grid">
      <div class="stat"><div style="font-size:18px;font-weight:700" id="statTotal">0</div><div>Total Clicks</div></div>
      <div class="stat"><div style="font-size:18px;font-weight:700" id="statBits">0</div><div>Total Bits</div></div>
      <div class="stat"><div style="font-size:18px;font-weight:700" id="statPrestige">0</div><div>Prestige</div></div>
      <div class="stat"><div style="font-size:18px;font-weight:700" id="statUpgrades">0</div><div>Upgrades Owned</div></div>
    </div>
    <div style="margin-top:10px;">
      <div style="text-align:center;color:#bbb">Playtime</div>
      <div id="statPlaytime" style="text-align:center;color:#ddd;margin-top:6px">0s</div>
    </div>
  </div>

<script>
/* ------------------------------
   STORAGE & INITIAL STATE
   ------------------------------ */
let count = parseFloat(localStorage.getItem('count')) || 0;
let totalClicks = parseFloat(localStorage.getItem('totalClicks')) || 0;
let bits = parseFloat(localStorage.getItem('bits')) || 0;
let totalBitsEarned = parseFloat(localStorage.getItem('totalBitsEarned')) || 0;
let bitsSpent = parseFloat(localStorage.getItem('bitsSpent')) || 0;
let unlocked = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
let prestigeCount = parseInt(localStorage.getItem('prestigeCount')) || 0;
let firstSeen = parseInt(localStorage.getItem('firstSeen')) || Date.now();
let savedPlaytime = parseInt(localStorage.getItem('savedPlaytime')) || 0;
let lastPlayed = parseInt(localStorage.getItem('lastPlayed')) || Date.now();
let sessionStart = Date.now();
let offlineClicksEarned = parseInt(localStorage.getItem('offlineClicksEarned')) || 0;

/* upgrades structure */
let upgrades = JSON.parse(localStorage.getItem('upgrades')) || {
  finger: 0,
  mouse: 0,
  energy: 0,
  magnet: 0,
  turbo: 0,
  factory: 0,
  bank: 0
};

/* UI */
const countEl = document.getElementById('count');
const cpsEl = document.getElementById('cps');
const clickBtn = document.getElementById('clicker');
const achBtn = document.getElementById('achBtn');
const upgBtn = document.getElementById('upgBtn');
const statsBtn = document.getElementById('statsBtn');
const prestigeBtn = document.getElementById('prestigeBtn');
const resetBtn = document.getElementById('resetBtn');

const bitsCur = document.getElementById('bitsCur');
const bitsPerClickEl = document.getElementById('bitsPerClick');
const multCur = document.getElementById('multCur');

const toastContainer = document.getElementById('toastContainer');

const achPanel = document.getElementById('achPanel');
const achList = document.getElementById('achList');
const closeAch = document.getElementById('closeAch');

const upgPanel = document.getElementById('upgPanel');
const upgList = document.getElementById('upgList');
const closeUpg = document.getElementById('closeUpg');

const statsPanel = document.getElementById('statsPanel');
const closeStats = document.getElementById('closeStats');
const statTotal = document.getElementById('statTotal');
const statBits = document.getElementById('statBits');
const statPrestige = document.getElementById('statPrestige');
const statUpgrades = document.getElementById('statUpgrades');
const statPlaytime = document.getElementById('statPlaytime');

/* ------------------------------
   ACHIEVEMENTS (with secrets)
   ------------------------------ */
const achievements = {
  "1": { text: "Ah yes, the first click. So the journey begins.", secret:false },
  "5": { text: "You've clicked... once? Twice? Eh..", secret:false },
  "10": { text: "You’ve clicked 10 times. Mildly impressive.", secret:false },
  "15": { text: "Getting the hang of it I see.", secret:false },
  "25": { text: "Is your finger okay?", secret:false },
  "42": { text: "42 clicks — the answer to everything.", secret:false },
  "69": { text: "Nice", secret:false },
  "100": { text: "You clearly have nothing better to do.", secret:false },
  "200": { text: "Really...", secret:false },
  "250": { text: "You’re kinda scary with this speed.", secret:false },
  "300": { text: "You might have a mild obsession.", secret:false },
  "333": { text: "Triple Threat, oh no.", secret:false },
  "420": { text: "Blaze it.", secret:false },
  "500": { text: "Your dedication is both admirable and concerning.", secret:false },
  "666": { text: "Uh oh… something feels evil.", secret:false },
  "6969": { text: "Nice... again.", secret:true },           // secret example
  "750": { text: "Stop. Just... stop.", secret:false },
  "800": { text: "Almost to 1000, proud of yourself?", secret:false },
  "900": { text: "Okay, this is a little much..", secret:false },
  "1000": { text: "You have reached enlightenment. Stop now. Or don’t.", secret:false },
  "1111": { text: "You like patterns, huh?", secret:false },
  "1200": { text: "Why are you still here?", secret:false },
  "1234": { text: "Sequential! Wow.", secret:false },
  "1337": { text: "Leet clicker.", secret:false },
  "1500": { text: "You clearly have no social life.. oof", secret:false },
  "2000": { text: "Are you okay?", secret:false },
  "2500": { text: "Your mouse/screen is crying.", secret:false },
  "3000": { text: "Do you not have a life?", secret:false },
  "3500": { text: "Your mouse deserves hazard pay.", secret:false },
  "4000": { text: "Someone call a mental institute.. please", secret:false },
  "4040": { text: "Achievement not found.", secret:false },
  "4500": { text: "You could've baked a cake by now you know.", secret:false },
  "5000": { text: "You might need help.", secret:false },
  "5500": { text: "Yeah, you need help..", secret:false },
  "6000": { text: "Please bro, why are you still here...", secret:false },
  "6500": { text: "Your mouse/finger deserves a break.. jeez", secret:false },
  "7000": { text: "Go to bed or something.", secret:false },
  "7500": { text: "Okay, you’ve proven your point.", secret:false },
  "8000": { text: "Why.", secret:false },
  "8500": { text: "Achievement hunting like a pro.", secret:false },
  "9000": { text: "I'm telling your mom..", secret:false },
  "9500": { text: "You really have no life huh?", secret:false },
  "10000": { text: "Touch grass, please.", secret:false },
  "10001": { text: "Secret Achievement unlocked. You good?", secret:true },
  "11000": { text: "Double digits in the thousands? Wow.", secret:false },
  "12000": { text: "The universe is judging you...", secret:false },
  "12345": { text: "Counted sequentially, didn’t you?", secret:true },
  "15000": { text: "You may have broken reality.", secret:false },
  "17000": { text: "You've got to do something else soon right?", secret:false},
  "18500": { text: "Jeez. You really need a life.", secret:true},
  "20000": { text: "Clicking is life now, isn't it?", secret:false },
  "25000": { text: "You're officially a legend... or maybe insane. Idk yet...", secret:false },
  "30000": { text: "You're breaking records no one tracks..", secret:false },
  "35000": { text: "Do you really have nothing to do rn?", secret:false },
  "40000": { text: "I get it bro. You can calm down now...", secret:false },
  "45000": { text: "Fuck my eyes - Colton", secret:false },
  "50000": { text: "Again, just why?", secret:false },
  "55000": { text: "So uh, when you stopping?", secret:false },
  "69696": { text: "Ultimate nice achieved.", secret:true },
  "70000": { text: "You really gotta stop man.", secret:false},
  "80000": { text: "This is getting out of hand.", secret:false},
  "90000": { text: "Soooo... When we stopping???", secret:false},
  "99999": { text: "How did you even get here?", secret:true},
  "100000": { text: "Do you always no-life games like this?", secret:false},
  "120000": { text: "What's the point? Are you THAT bored?", secret:false},
  "150000": { text: "I'm not impressed anymore...", secret:false},
  "200000": { text: "Any minute now you'll give up.... right?", secret:true},
  "250000": { text: "Do you get bullied?", secret:false},
  "300000": { text: "You should.", secret:false},
  "500000": { text: "Just give up already.", secret:false},
  "700000": { text: "You really are annoying", secret:true},
  "1000000": { text: "I hope you get/got bullied in school.", secret:false},
  "1500000": { text: "You really need to get a life..", secret:false},
  "2000000": { text: "Mhm. Just keeping wasting your life.", secret:false},
  "3000000": { text: "Go do something productive man.", secret:false},
  "4000000": { text: "You need to stop. Like actually..", secret:true},
  "4040404": { text: "Really weird error message here..", secret:true},
  "5000000": { text: "Really....", secret:false},
  "6000000": { text: "You must actually be bored.", secret:false},
  "7000000": { text: "Time to shower bro...", secret:true},
  "8000000": { text: "Please... just stop..", secret:false},
  "9000000": { text: ".....", secret:false},
  "10000000": { text: "Point's been proven dude.. get off.", secret:false}
};

/* ------------------------------
   UTILS & BALANCE
   ------------------------------ */
function getClickPrestigeMultiplier() {
  if (prestigeCount <= 0) return 1;
  return 1 + Math.pow(prestigeCount * 0.1, 1.3);
}
function getBitsPrestigeMultiplier() {
  return Math.pow(1.15, prestigeCount);
}
function getBaseBitsPerClick() {
  let base = 1 + (upgrades.bank || 0) * 0.2; // bank adds +0.2 bits per click per level
  let mult = getBitsPrestigeMultiplier();
  if (upgrades.magnet && upgrades.magnet > 0) mult *= 2;
  return base * mult;
}
function getClickPower() {
  let base = 1;
  base += (upgrades.finger || 0) * 0.1;
  base += (upgrades.mouse || 0) * 0.25;
  base += (upgrades.turbo || 0) * 0.5; // turbo glove adds 0.5 per level
  return base * getClickPrestigeMultiplier();
}
function getAutoClicksPerSec() {
  return (upgrades.energy || 0) * 1 + (upgrades.factory || 0) * 5; // factory adds 5 clicks/sec per level
}
function costFor(levelBase, lvl, scale=1.5) {
  return Math.ceil(levelBase * Math.pow(scale, lvl));
}
function fmt(n) { return Math.floor(n).toLocaleString(); }
function fmtFloat(n, digits=2) { return Number(n).toFixed(digits); }

/* ------------------------------
   SHOP (add new upgrades)
   ------------------------------ */
const shop = [
  { id:'finger', name:'Finger Strength', desc:'+0.1 click power per level', baseCost:50 },
  { id:'mouse',  name:'Fancy Mouse', desc:'+0.25 click power per level', baseCost:200 },
  { id:'energy', name:'Energy Drink', desc:'+1 auto-click/sec per level', baseCost:250 },
  { id:'turbo', name:'Turbo Glove', desc:'+0.5 click power per level', baseCost:1000 },
  { id:'factory', name:'Auto Factory', desc:'+5 auto-click/sec per level', baseCost:2500 },
  { id:'bank', name:'Bit Bank', desc:'+0.2 bits per click per level', baseCost:1500 },
  { id:'magnet', name:'Bit Magnet (secret)', desc:'Double Bits gain (one-time, unlocks at 5,000 bits this run)', baseCost:5000, secret:true, oneTime:true }
];

/* ------------------------------
   TOASTS
   ------------------------------ */
function showToast(title, message, secret=false) {
  const t = document.createElement('div');
  t.className = 'toast' + (secret ? ' gold' : '');
  t.innerHTML = `<div class="toast-title">${title}</div><div>${message}</div>`;
  toastContainer.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=> {
    t.classList.remove('show');
    setTimeout(()=> t.remove(), 380);
  }, 3200);
}

/* ------------------------------
   SAVE helpers
   ------------------------------ */
function saveAll() {
  localStorage.setItem('count', String(count));
  localStorage.setItem('totalClicks', String(totalClicks));
  localStorage.setItem('bits', String(bits));
  localStorage.setItem('totalBitsEarned', String(totalBitsEarned));
  localStorage.setItem('bitsSpent', String(bitsSpent));
  localStorage.setItem('unlockedAchievements', JSON.stringify(unlocked));
  localStorage.setItem('prestigeCount', String(prestigeCount));
  localStorage.setItem('firstSeen', String(firstSeen));
  localStorage.setItem('savedPlaytime', String(savedPlaytime + (Date.now() - sessionStart)));
  localStorage.setItem('lastPlayed', String(Date.now()));
  localStorage.setItem('offlineClicksEarned', String(offlineClicksEarned));
  localStorage.setItem('upgrades', JSON.stringify(upgrades));
}

/* ------------------------------
   ACHIEVEMENTS MANAGEMENT
   ------------------------------ */
function autoUnlockExisting() {
  const cur = Math.floor(count);
  let changed = false;
  Object.keys(achievements).forEach(k=>{
    const thresh = parseInt(k);
    if (cur >= thresh && !unlocked.includes(k)) {
      unlocked.push(k);
      const secret = achievements[k].secret === true;
      showToast('Achievement Earned!', achievements[k].text, secret);
      changed = true;
    }
  });
  if (changed) saveUnlocked();
}
function saveUnlocked() { localStorage.setItem('unlockedAchievements', JSON.stringify(unlocked)); }

function updateAchievementsPanel() {
  achList.innerHTML = '';
  let shownAny = false;
  const keys = Object.keys(achievements).map(k=>parseInt(k)).sort((a,b)=>a-b);
  for (const k of keys) {
    const key = String(k);
    const info = achievements[key];
    if (info.secret && !unlocked.includes(key)) continue;
    const div = document.createElement('div');
    div.className = 'achievement';
    if (unlocked.includes(key)) {
      if (info.secret) div.classList.add('secret','unlocked');
      else div.classList.add('unlocked');
      const title = info.secret ? 'Secret Achievement' : `Clicks: ${key}`;
      div.innerHTML = `<div class="title">${title}</div><div>${info.text}</div>`;
    } else {
      div.innerHTML = `<div class="title">???</div><div>???</div>`;
    }
    achList.appendChild(div);
    shownAny = true;
  }
  if (!shownAny) achList.innerHTML = `<div class="no-items">No achievements unlocked yet.</div>`;
}

/* ------------------------------
   SHOP RENDER & BUY
   ------------------------------ */
function renderShopInner() {
  upgList.innerHTML = '';
  for (const item of shop) {
    const lvl = upgrades[item.id] || 0;
    const price = costFor(item.baseCost, lvl, 1.55);
    const div = document.createElement('div');
    div.className = 'upgrade';

    // If magnet and not eligible, show locked message instead of buy
    if (item.id === 'magnet' && (bits < 5000 && (upgrades.magnet || 0) === 0)) {
      div.innerHTML = `
        <div class="meta">
          <div class="name">${item.name}</div>
          <div style="font-size:0.9rem;color:#ccc">${item.desc}</div>
          <div style="font-size:0.85rem;color:#aaa">Locked until you have 5,000 bits this run</div>
        </div>
        <div style="text-align:right;color:#999">Hidden</div>
      `;
    } else {
      div.innerHTML = `
        <div class="meta">
          <div class="name">${item.name}${item.oneTime && lvl>0 ? ' (owned)' : ''}</div>
          <div style="font-size:0.9rem;color:#ccc">${item.desc}</div>
          <div style="font-size:0.85rem;color:#aaa">Level: ${lvl}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <div style="font-weight:700">${price.toLocaleString()} bits</div>
          <button class="buy-btn small" data-id="${item.id}" ${ (item.oneTime && lvl>0) ? 'disabled' : '' }>${ (item.oneTime && lvl>0) ? 'Owned' : 'Buy' }</button>
        </div>
      `;
    }

    upgList.appendChild(div);
  }

  document.querySelectorAll('.buy-btn').forEach(btn=>{
    btn.onclick = ()=> {
      const id = btn.getAttribute('data-id');
      buyUpgrade(id);
    };
  });
}

function buyUpgrade(id) {
  const item = shop.find(s=>s.id===id);
  if (!item) return;
  const lvl = upgrades[id] || 0;
  const price = costFor(item.baseCost, lvl, 1.55);
  if (bits < price) { showToast('Not enough Bits', `You need ${price} bits.`); return; }
  bits -= price;
  bitsSpent += price;
  if (item.oneTime) upgrades[id] = 1;
  else upgrades[id] = lvl + 1;
  if (id === 'energy' || id === 'factory') startAutoClicker();
  saveAll();
  renderShopInner();
  refreshUI();
  showToast('Purchased', `${item.name} purchased!`);
}

/* ------------------------------
   AUTO-CLICKER (live)
   ------------------------------ */
let autoInterval = null;
function startAutoClicker() {
  if (autoInterval) return;
  autoInterval = setInterval(()=>{
    const perSec = getAutoClicksPerSec();
    if (perSec <= 0) return;
    const gained = perSec * getClickPower();
    count += gained;
    totalClicks += gained;
    const bitsGained = perSec * getBaseBitsPerClick();
    bits += bitsGained;
    totalBitsEarned += bitsGained;
    saveAll();
    checkAchievementsAfterIncrement();
    refreshUI();
  }, 1000);
}
function stopAutoClicker() {
  if (!autoInterval) return;
  clearInterval(autoInterval);
  autoInterval = null;
}

/* ------------------------------
   CPS (Clicks Per Second) sampling
   ------------------------------ */
const cpsSamples = []; // store recent totalClicks samples
const CPS_WINDOW = 5; // seconds
setInterval(()=>{
  cpsSamples.push(totalClicks);
  if (cpsSamples.length > CPS_WINDOW) cpsSamples.shift();
  if (cpsSamples.length >= 2) {
    const oldest = cpsSamples[0];
    const newest = cpsSamples[cpsSamples.length-1];
    const seconds = cpsSamples.length - 1;
    const cps = (newest - oldest) / seconds;
    cpsEl.textContent = `CPS: ${fmtFloat(cps,2)}`;
  } else {
    cpsEl.textContent = `CPS: 0`;
  }
}, 1000);

/* ------------------------------
   UI REFRESH
   ------------------------------ */
function getPrestigeCost() {
  return 10000 + prestigeCount * 10000; // increases by 10k each prestige
}

function refreshUI() {
  countEl.textContent = fmt(count);
  bitsCur.textContent = `Bits: ${fmt(bits)}`;
  bitsPerClickEl.textContent = `Bits/Click: ${fmtFloat(getBaseBitsPerClick(),2)}`;
  multCur.textContent = `x${getClickPrestigeMultiplier().toFixed(2)}`;
  const prestigeCost = getPrestigeCost();
  if (Math.floor(count) >= prestigeCost) {
    prestigeBtn.style.display = 'inline-block';
    prestigeBtn.textContent = `Prestige (requires ${prestigeCost.toLocaleString()} clicks)`;
    prestigeBtn.classList.add('prestige-ready');
  } else {
    prestigeBtn.style.display = 'none';
    prestigeBtn.classList.remove('prestige-ready');
  }
  updateAchievementsPanel();
  updateStatsPanel();
  renderShopInner();
}

/* ------------------------------
   CHECK ACHIEVEMENTS after increment
   ------------------------------ */
function checkAchievementsAfterIncrement() {
  const cur = Math.floor(count);
  let any = false;
  const keys = Object.keys(achievements).map(k=>parseInt(k)).sort((a,b)=>a-b);
  for (const k of keys) {
    const key = String(k);
    if (cur >= k && !unlocked.includes(key)) {
      unlocked.push(key);
      any = true;
      const secret = achievements[key].secret === true;
      showToast('Achievement Earned!', achievements[key].text, secret);
    }
  }
  if (any) saveUnlocked();
}
function saveUnlocked() { localStorage.setItem('unlockedAchievements', JSON.stringify(unlocked)); }

/* ------------------------------
   OFFLINE GAIN
   ------------------------------ */
function handleOfflineGain() {
  const now = Date.now();
  const secsAway = Math.floor((now - lastPlayed) / 1000);
  if (secsAway < 5) {
    lastPlayed = now;
    localStorage.setItem('lastPlayed', String(lastPlayed));
    return;
  }
  const baseClicks = Math.floor(secsAway / 5);
  const multiplier = 1 + (upgrades.energy || 0);
  const offlineClicks = Math.floor(baseClicks * multiplier);
  if (offlineClicks <= 0) { lastPlayed = now; localStorage.setItem('lastPlayed', String(lastPlayed)); return; }
  const clicksGained = offlineClicks * getClickPower();
  const bitsGained = offlineClicks * getBaseBitsPerClick();
  count += clicksGained;
  totalClicks += clicksGained;
  bits += bitsGained;
  totalBitsEarned += bitsGained;
  offlineClicksEarned += offlineClicks;
  lastPlayed = now;
  localStorage.setItem('lastPlayed', String(lastPlayed));
  saveAll();
  showToast('Welcome back!', `You earned ${fmt(offlineClicks)} offline clicks (+${fmtFloat(bitsGained,2)} bits).`);
  checkAchievementsAfterIncrement();
}

/* ------------------------------
   CLICK HANDLER
   ------------------------------ */
clickBtn.addEventListener('click', () => {
  const clickGain = getClickPower();
  count += clickGain;
  totalClicks += clickGain;
  const bitsGained = getBaseBitsPerClick();
  bits += bitsGained;
  totalBitsEarned += bitsGained;
  saveAll();
  checkAchievementsAfterIncrement();
  refreshUI();
});

/* ------------------------------
   PRESTIGE
   ------------------------------ */
prestigeBtn.addEventListener('click', ()=>{
  const req = getPrestigeCost();
  if (Math.floor(count) < req) return;
  if (!confirm(`Prestiging resets current clicks, Bits and upgrades but gives a permanent +15% Bits gain per prestige. Proceed?`)) return;
  prestigeCount++;
  count = 0;
  bits = 0;
  upgrades = { finger:0, mouse:0, energy:0, magnet:0, turbo:0, factory:0, bank:0 };
  stopAutoClicker();
  saveAll();
  saveUnlocked();
  showToast('Prestige!', `You prestiged. Prestige level: ${prestigeCount}. Bits gain increased.`, true);
  refreshUI();
});

/* ------------------------------
   RESET (clear everything)
   ------------------------------ */
resetBtn.addEventListener('click', ()=>{
  if (!confirm('Erase ALL progress (clicks, bits, prestige, upgrades)?')) return;
  localStorage.clear();
  count=0; totalClicks=0; bits=0; totalBitsEarned=0; bitsSpent=0; unlocked=[]; prestigeCount=0;
  upgrades={finger:0,mouse:0,energy:0,magnet:0,turbo:0,factory:0,bank:0}; savedPlaytime=0; sessionStart=Date.now(); lastPlayed=Date.now(); offlineClicksEarned=0;
  stopAutoClicker();
  showToast('Reset', 'All progress erased.');
  refreshUI();
});

/* ------------------------------
   PANELS open/close
   ------------------------------ */
achBtn.addEventListener('click', ()=>{ achPanel.classList.toggle('show'); achPanel.setAttribute('aria-hidden', !achPanel.classList.contains('show')); updateAchievementsPanel(); });
closeAch.addEventListener('click', ()=>{ achPanel.classList.remove('show'); achPanel.setAttribute('aria-hidden','true'); });

upgBtn.addEventListener('click', ()=>{ upgPanel.classList.toggle('show'); upgPanel.setAttribute('aria-hidden', !upgPanel.classList.contains('show')); renderShopInner(); });
closeUpg.addEventListener('click', ()=>{ upgPanel.classList.remove('show'); upgPanel.setAttribute('aria-hidden','true'); });

statsBtn.addEventListener('click', ()=>{ statsPanel.classList.toggle('show'); statsPanel.setAttribute('aria-hidden', !statsPanel.classList.contains('show')); updateStatsPanel(); });
closeStats.addEventListener('click', ()=>{ statsPanel.classList.remove('show'); statsPanel.setAttribute('aria-hidden','true'); });

/* ------------------------------
   SHOP and save on unload
   ------------------------------ */
document.addEventListener('touchstart', function(e){ if (e.target.tagName === 'BUTTON') { e.preventDefault(); e.target.click(); } }, { passive:false });

window.addEventListener('beforeunload', ()=>{
  const now = Date.now();
  const sess = now - sessionStart;
  savedPlaytime += sess;
  localStorage.setItem('savedPlaytime', String(savedPlaytime));
  lastPlayed = now;
  localStorage.setItem('lastPlayed', String(lastPlayed));
  saveAll();
});

/* ------------------------------
   ON LOAD: run setup
   ------------------------------ */
window.addEventListener('load', ()=>{
  if (!firstSeen) { firstSeen = Date.now(); localStorage.setItem('firstSeen', String(firstSeen)); }
  handleOfflineGain();
  if ((upgrades.energy || 0) > 0 || (upgrades.factory || 0) > 0) startAutoClicker();
  autoUnlockExisting();
  refreshUI();
});

/* ------------------------------
   STATS HELPERS
   ------------------------------ */
function countOwnedUpgrades() {
  return (upgrades.finger||0) + (upgrades.mouse||0) + (upgrades.energy||0) + (upgrades.magnet||0) + (upgrades.turbo||0) + (upgrades.factory||0) + (upgrades.bank||0);
}
function updateStatsPanel() {
  statTotal.textContent = Math.floor(totalClicks).toLocaleString();
  statBits.textContent = Math.floor(totalBitsEarned).toLocaleString();
  statPrestige.textContent = prestigeCount;
  statUpgrades.textContent = countOwnedUpgrades();
  const now = Date.now();
  const playMs = savedPlaytime + (now - sessionStart);
  const s = Math.floor(playMs/1000), h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  statPlaytime.textContent = h ? `${h}h ${m}m ${sec}s` : (m ? `${m}m ${sec}s` : `${sec}s`);
}

/* ------------------------------
   RENDER SHOP INIT & UI
   ------------------------------ */
renderShopInner();
refreshUI();
</script>
</body>
</html>
